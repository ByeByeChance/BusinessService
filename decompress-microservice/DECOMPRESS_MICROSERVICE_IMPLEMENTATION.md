# 资源管理模块微服务拆分 - 文件解压缩功能

## 实现方案概述

本方案实现了资源管理模块与微服务的整合，主要功能是：
- 支持前端分片上传大文件（镜像压缩包/算法压缩包等）
- 服务器端文件合并
- 文件MD5校验防止损坏
- 调用解压缩微服务进行文件解压缩
- 根据资源类型存储到特定目录
- 记录解压缩后的文件存放地址

## 项目结构

```
项目根目录/
├── src/
│   ├── api/
│   │   └── resource/           # 资源管理模块
│   │       ├── controller/     # 控制器
│   │       ├── dto/            # 数据传输对象
│   │       ├── entities/       # 实体类
│   │       ├── service/        # 服务层
│   │       └── module.ts       # 模块配置
│   └── microService/           # 微服务模块
│       ├── controller.ts       # 微服务控制器
│       └── module.ts           # 微服务模块配置
└── decompress-microservice/    # 解压缩微服务（独立项目）
    ├── src/
    │   ├── controller.ts       # 解压缩控制器
    │   ├── service.ts          # 解压缩服务
    │   └── module.ts           # 微服务模块
    └── main.ts                 # 微服务入口
```

## 核心实现

### 1. 微服务客户端配置

在 `src/microService/microService.module.ts` 中添加解压缩微服务客户端配置：

```typescript
{
  name: 'DECOMPRESS_SERVICE',
  transport: Transport.TCP,
  options: {
    port: 7777,
  },
}
```

### 2. 资源服务整合

在 `src/api/resource/resource.service.ts` 中：

- 注入解压缩微服务客户端
- 在 `mergeChunks` 方法中添加文件校验和解压缩逻辑
- 实现文件MD5生成方法
- 实现压缩文件判断方法
- 实现解压缩微服务调用方法

### 3. 实体类扩展

在 `src/api/resource/entities/resource.entity.ts` 中添加：

- `md5` 字段：用于存储文件MD5校验值
- `decompressPath` 字段：用于存储解压缩后的文件路径

### 4. 解压缩微服务实现

创建独立的解压缩微服务项目，支持多种压缩格式：
- ZIP (.zip)
- TAR (.tar)
- TAR.GZ (.tar.gz, .tgz)
- GZ (.gz)
- RAR (.rar)

## 安装与部署

### 1. 主项目配置

确保主项目已安装 `@nestjs/microservices` 依赖：

```bash
npm install @nestjs/microservices
```

### 2. 解压缩微服务部署

```bash
# 进入解压缩微服务目录
cd decompress-microservice

# 安装依赖
npm install

# 构建项目
npm run build

# 启动服务
npm start
```

### 3. 配置说明

在主项目的配置文件中添加以下配置：

```json
{
  "DECOMPRESS": {
    "BASE_DIR": "/opt/decompressed"  // 解压缩文件的基础目录
  }
}
```

## 使用方法

### 1. 前端分片上传

前端需要实现分片上传逻辑，主要步骤：

1. 初始化上传：调用 `POST /resource/init-upload` 获取资源ID
2. 分片上传：调用 `POST /resource/upload-chunk` 上传文件分片
3. 合并文件：调用 `POST /resource/merge-chunks` 合并分片并触发解压缩

### 2. 解压缩结果查询

文件解压缩完成后，可以通过以下方式获取解压缩路径：

```bash
# 查询资源详情
GET /resource/:resourceId
```

响应中会包含 `decompressPath` 字段，表示解压缩后的文件存放路径。

## 目录结构说明

解压缩后的文件会根据资源类型存储到不同目录：

```
/opt/decompressed/
├── images/            # 镜像压缩包解压缩目录
│   └── {resourceId}/  # 按资源ID分类
├── algorithms/        # 算法压缩包解压缩目录
│   └── {resourceId}/  # 按资源ID分类
└── others/            # 其他类型文件解压缩目录
    └── {resourceId}/  # 按资源ID分类
```

## 注意事项

1. **依赖安装**：解压缩微服务需要安装相应的依赖，特别是解压缩RAR文件需要系统安装 `unrar` 工具。

2. **目录权限**：确保服务器上的解压缩目录有足够的读写权限。

3. **微服务通信**：确保主服务与解压缩微服务之间的网络通信正常，端口7777未被占用。

4. **文件大小限制**：根据实际需求调整配置文件中的文件大小限制和分片大小。

5. **错误处理**：解压缩失败不会影响主流程，但会在资源记录中标记为失败状态。

## 扩展建议

1. **支持更多压缩格式**：可以根据需要扩展解压缩服务，支持更多压缩格式。

2. **解压缩进度监控**：可以添加解压缩进度监控功能，实时反馈解压缩进度。

3. **解压缩结果回调**：可以实现解压缩完成后的回调机制，通知相关服务处理解压缩后的文件。

4. **分布式文件存储**：可以将解压缩后的文件存储到分布式文件系统中，提高可用性和扩展性。

5. **安全验证**：可以添加文件内容安全验证，防止恶意文件上传和执行。

## 故障排查

1. **文件上传失败**：检查网络连接、文件大小限制、分片大小配置。

2. **文件合并失败**：检查临时目录权限、文件大小匹配、分片完整性。

3. **文件校验失败**：检查MD5计算是否正确、文件是否在传输过程中损坏。

4. **解压缩失败**：检查解压缩微服务是否正常运行、文件格式是否支持、解压缩目录权限。

5. **微服务通信失败**：检查微服务是否启动、端口是否正确、网络连接是否正常。
